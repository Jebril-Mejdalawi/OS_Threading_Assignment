//JEBREEL EMAD ABEDAL KAREEM MAJDALWIEH 133050
//ISLAM ZAID SULEIMAN ALSHQEIRAT 133034
//SHATHA HOSSAM ISSA MUSTAFA 133844


#include <pthread.h>
#include <stdio.h>
#include<stdlib.h>
#include<stdint.h>
#include <sys/types.h>
#include <unistd.h>
#include <sys/syscall.h>





//**************************************************************************************************************************************************
//**************************************************************************************************************************************************
//*************************GLOBAL VARIABLES *********************************************************************************************
//**************************************************************************************************************************************************
//**************************************************************************************************************************************************





int Even = 0, Odd = 0, Total = 0;   //(write)
int t;                      //number of threads (read only)
int n;                      //Matrix Size       (read only)
int** matrix1;              //input matrix  (read only)
int** matrix2;              //input matrix  (read only)
int** matrix3;              //output matrix (write)
FILE* wfptr;                //(write)
FILE* rfptr;





//**************************************************************************************************************************************************
//**************************************************************************************************************************************************
//************************* MULTI FUNCTION *********************************************************************************************************
//**************************************************************************************************************************************************
//**************************************************************************************************************************************************

void* multi(void* x)
{

    //important : we distrebuted the work on the threads equally by rows, n/t finds how many rows each thread works on

    int b = (int64_t)x;   //casting from void* to int, x resembles the thread number(ID)
    int s = b * (n / t);       //start loop , calculated from the thread number 
    int e = s + (n / t);       //end loop   ,calculated from the thread number 



    printf("ThreadID=%d, startLoop=%d, endLoop=%d\n\n", b, s, e);
    fprintf(wfptr, "ThreadID=%d, startLoop=%d, endLoop=%d\n\n", b, s, e);

    int sum = 0;
    for (int k = s; k < e; k++)
        for (int i = 0; i < n; i++)
        {
            sum = 0;
            for (int j = 0; j < n; j++)
                sum += matrix1[k][j] * matrix2[j][i];


            matrix3[k][i] = sum;


            if (sum % 2 == 0)
                Even++;
            else
                Odd++;
            Total++;

        }



}






int main(int argc, char* argv[])
{

    //**************************************************************************************************************************************************
    //**************************************************************************************************************************************************
    //*************************MAIN OPEINING  *********************************************************************************************
    //**************************************************************************************************************************************************
    //**************************************************************************************************************************************************


    wfptr = fopen("out.txt", "w");
    rfptr = fopen("in.txt", "r");



    fscanf(rfptr, "%d", &n); //reading n from file


    t = atoi(argv[1]);    //reading t from Argv (passed in the command line)





//**************************************************************************************************************************************************
//**************************************************************************************************************************************************
//*************************  ALLOCATING MATRICES  **************************************************************************************************
//**************************************************************************************************************************************************
//**************************************************************************************************************************************************


    matrix1 = (int**)malloc(n * sizeof(int*));              //allocating double pointer to make a 2D Array(matrix)  matrix1[n][n]
    for (int i = 0; i < n; i++)
        matrix1[i] = (int*)malloc(n * sizeof(int));


    matrix2 = (int**)malloc(n * sizeof(int*));             //allocating double pointer to make a 2D Array(matrix)  matrix2[n][n]
    for (int i = 0; i < n; i++)
        matrix2[i] = (int*)malloc(n * sizeof(int));

    matrix3 = (int**)malloc(n * sizeof(int*));              //allocating double pointer to make a 2D Array(matrix)  matrix3[n][n]
    for (int i = 0; i < n; i++)
        matrix3[i] = (int*)malloc(n * sizeof(int));




    //**************************************************************************************************************************************************
    //******************************     Reading Matrices       ****************************************************************************************
    //**************************************************************************************************************************************************
    //**************************************************************************************************************************************************



    for (int i = 0; i < n; i++)                          //reading matrix1 from the input file
        for (int j = 0; j < n; j++)
            fscanf(rfptr, "%d", &matrix1[i][j]);




    for (int i = 0; i < n; i++)                           //reading matrix2 from the input file
        for (int j = 0; j < n; j++)
            fscanf(rfptr, "%d", &matrix2[i][j]);




    //**************************************************************************************************************************************************
    //**************************************************************************************************************************************************
    //*************************PTHREAD Thread CREATE and JOIN *********************************************************************************************
    //**************************************************************************************************************************************************
    //**************************************************************************************************************************************************            





    pthread_t* threads = malloc(t * sizeof(pthread_t));    //allocating a dynamic array of type pthread 



    int ef; // for exit

    for (intptr_t i = 0; i < t; i++)        //a loop that executes t times
    {

        ef = pthread_create(&threads[i], NULL, multi, (void*)i); //creating threads which execute the function "multi" and passing thread number (id) to the function




        if (ef)  //Errors Handling 
        {
            printf("\n\n A problem has occured \n\n");
            exit(-1);
        }
    }


    for (int i = 0; i < t; i++)  //JOIN 
    {
        pthread_join(threads[i], NULL);
    }




    //**************************************************************************************************************************************************
    //**************************************************************************************************************************************************
    //************************* TEST MATRICES OUTPUT ***************************************************************************************************
    //**************************************************************************************************************************************************
    //**************************************************************************************************************************************************

    //Testing the output and the result of the matrix multiplication 
    /*
        printf("the First matrix : \n\n");
        fprintf(wfptr,"the First matrix : \n\n");
        for(int i=0;i<n;i++)
            {for(int j=0;j<n;j++)
                {printf("%d ",matrix1[i][j]);
                fprintf(wfptr,"%d ",matrix1[i][j]);
                }
                printf("\n\n");
                fprintf(wfptr,"\n\n");
            }

       fprintf(wfptr,"\n\n");

         printf("the second matrix : \n\n");
        fprintf(wfptr,"the second matrix : \n\n");
        for(int i=0;i<n;i++)
            {for(int j=0;j<n;j++)
                {printf("%d ",matrix2[i][j]);
                fprintf(wfptr,"%d ",matrix2[i][j]);
                }
                printf("\n\n");
                fprintf(wfptr,"\n\n");
            }

       fprintf(wfptr,"\n\n");

        printf("the 3rd matrix : \n\n");
            fprintf(wfptr,"the 3rd matrix : \n\n");

       for(int i=0;i<n;i++)
            {for(int j=0;j<n;j++)
                {printf("%d ",matrix3[i][j]);
                            fprintf(wfptr,"%d ",matrix3[i][j]);

                }
                printf("\n");
               fprintf(wfptr,"\n");
            }

      printf("\n\n");*/


      //**************************************************************************************************************************************************
      //**************************************************************************************************************************************************
      //*************************Printing And Writing Total,Odd,Even on FILE *****************************************************************************
      //**************************************************************************************************************************************************
      //**************************************************************************************************************************************************


             //FILE *tfptr;
              //tfptr=fopen("test.txt","a");
              //fprintf( tfptr,"numOfEven= %d, numOfOdd=%d, totalCells=%d \n\n",Even,Odd,Total); //testing the output of multiple runs with different numbers of threads
                                                                                                  // to make sure that our code is thread safe 


    printf("numOfEven= %d, numOfOdd=%d, totalCells=%d ", Even, Odd, Total);
    fprintf(wfptr, "numOfEven= %d, numOfOdd=%d, totalCells=%d \n\n", Even, Odd, Total);



    //**************************************************************************************************************************************************
    //**************************************************************************************************************************************************
    //*************************ENDING ******************************************************************************************************************
    //**************************************************************************************************************************************************
    //**************************************************************************************************************************************************

                                                    //deallocating the dynamic arrays
    for (int i = 0; i < n; i++)
    {
        free(matrix1[i]);
        free(matrix2[i]);
        free(matrix3[i]);
    }

    free(matrix1);
    free(matrix2);
    free(matrix3);
    free(threads);


    fclose(rfptr);
    fclose(wfptr);
    //fclose(tfptr);

    pthread_exit(NULL);  //to exit the main thread
}